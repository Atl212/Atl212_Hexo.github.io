// Import the 'hexo-fs' module for file system operations
const fs = require('hexo-fs');

// Import the 'clean-css' module for CSS minification
const CleanCSS = require('clean-css');

// Define the path to the 'darkmode.css' file, using the current directory (__dirname)
const stylePath = __dirname + '/darkmode.css';

// Export a function named 'addStyle' that takes 'htmlContent' as an argument
module.exports.addStyle = function(htmlContent) {
    // Define an inner function 'injectExtraStyle' to handle CSS injection
    let injectExtraStyle = function () {
        // Check if the 'darkmode.css' file exists; throw an error if it doesn't
        if (!fs.exists(stylePath)) throw new TypeError(stylePath + ' not found!');

        // Read the content of 'darkmode.css' file synchronously, with escaping enabled
        let styleSourceCode = fs.readFileSync(stylePath, { escape: true });

        // Minify the CSS content using CleanCSS and wrap it in <style> tags
        return '<style>' + new CleanCSS().minify(styleSourceCode).styles + '</style>';
    };

    // Check if the HTML content contains a '</head>' tag (case-insensitive)
    if (/<\/head>/gi.test(htmlContent)) {
        // Find the last occurrence of '</head>' in the HTML content
        let lastIndex = htmlContent.lastIndexOf('</head>');

        // Insert the minified CSS style before the '</head>' tag by concatenating:
        // 1. HTML content before '</head>'
        // 2. The minified CSS from injectExtraStyle()
        // 3. HTML content from '</head>' to the end
        htmlContent = htmlContent.substring(0, lastIndex) + injectExtraStyle() + htmlContent.substring(lastIndex, htmlContent.length);
    }

    // Return the modified HTML content
    return htmlContent;
};